name: CI - Security Reports

on:
  push:
    branches: [ main ]

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install tools
        run: |
          npm install -g snyk snyk-to-html

      - name: Install project deps
        run: |
          cd backend && npm install || true
          cd ../frontend && npm install || true

      - name: Build containers
        run: |
          docker build -t backend-image:ci backend || true
          docker build -t frontend-image:ci frontend || true

      - name: Run containers
        run: |
          docker compose -f docker-compose.yml --profile ci up -d --build || true
          sleep 20

      - name: Snyk HTML Report
        run: |
          mkdir -p reports
          cd backend
          snyk test --json-file-output=../reports/snyk.json || true
          snyk-to-html -i ../reports/snyk.json -o ../reports/snyk-backend.html

      - name: Trivy HTML Report
        run: |
          mkdir -p reports
          trivy image backend-image:ci --format template --template "@contrib/html.tpl" --output reports/trivy-backend.html || true
          trivy image frontend-image:ci --format template --template "@contrib/html.tpl" --output reports/trivy-frontend.html || true

      - name: ZAP HTML Report
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: "http://localhost:10001/api/health"
          cmd_options: "-r zap.html"
        continue-on-error: true

      - name: Collect ALL security reports
        run: |
          mkdir -p reports
          if [ -f zap.html ]; then mv zap.html reports/zap-baseline.html; fi
          if [ -f zap-baseline.html ]; then mv zap-baseline.html reports/zap-baseline.html; fi
          if [ -f deepsource_report.html ]; then cp deepsource_report.html reports/deepsource_report.html; fi

      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: reports/
