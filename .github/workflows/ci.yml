name: CI - Banking DevSecOps Negative

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  build-and-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd backend && npm install || true
          cd ../frontend && npm install || true

      - name: Install security CLIs
        run: |
          npm install -g snyk snyk-to-html

      - name: Build and start services with docker-compose
        run: |
          docker compose -f docker-compose.yml --profile ci up -d --build
          sleep 20
          docker ps

      - name: Run Snyk scan (HTML)
        continue-on-error: true
        run: |
          mkdir -p reports
          cd backend
          snyk test --json-file-output=../reports/snyk.json || true
          snyk-to-html -i ../reports/snyk.json -o ../reports/snyk-backend.html

      - name: Run Trivy scan (HTML)
        continue-on-error: true
        run: |
          mkdir -p reports
          docker build -t backend-image:ci backend
          docker build -t frontend-image:ci frontend
          trivy image backend-image:ci --format template --template "@contrib/html.tpl" --output reports/trivy-backend.html || true
          trivy image frontend-image:ci --format template --template "@contrib/html.tpl" --output reports/trivy-frontend.html || true

      - name: Run OWASP ZAP baseline scan (HTML)
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:10001/api/health'
          rules_file_name: ''
          cmd_options: '-r zap-baseline.html'
        continue-on-error: true

      - name: Move ZAP report to reports folder
        run: |
          mkdir -p reports
          if [ -f zap-baseline.html ]; then
            mv zap-baseline.html reports/zap-baseline.html
          fi

      - name: Upload reports artifact
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: reports/
