stages:
  - install
  - build
  - security
  - dast

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  COMPOSE_PROFILES: ci
  COMPOSE_PROJECT_NAME: "ciapp"
  ZAP_TARGET: "http://backend:3000/api/health"

# -----------------------------------------------------
# INSTALL
# -----------------------------------------------------
install:
  stage: install
  image: node:20
  script:
    - cd backend && npm install || true
    - cd ../frontend && npm install || true
  artifacts:
    expire_in: 1 week
    paths:
      - backend/node_modules/
      - frontend/node_modules/

# -----------------------------------------------------
# BUILD IMAGES
# -----------------------------------------------------
build_images:
  stage: build
  image: docker:25
  services:
    - docker:25-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
    - docker build -t backend-image:ci backend || true
    - docker build -t frontend-image:ci frontend || true
    - docker save backend-image:ci -o backend-image.tar
    - docker save frontend-image:ci -o frontend-image.tar
  artifacts:
    expire_in: 1 week
    paths:
      - backend-image.tar
      - frontend-image.tar

# -----------------------------------------------------
# SECURITY = Snyk + Trivy
# -----------------------------------------------------
security_scans:
  stage: security
  image: node:20
  needs: ["install", "build_images"]
  before_script:
    - npm install -g snyk snyk-to-html
  script:
    - mkdir -p reports
    # Snyk
    - cd backend
    - snyk test --json-file-output=../reports/snyk.json || true
    - snyk-to-html -i ../reports/snyk.json -o ../reports/snyk-backend.html
    - cd ..
    # Trivy
    - trivy image backend-image:ci --format template --template "@contrib/html.tpl" --output reports/trivy-backend.html || true
    - trivy image frontend-image:ci --format template --template "@contrib/html.tpl" --output reports/trivy-frontend.html || true
    # DeepSource (static report)
    - if [ -f deepsource_report.html ]; then cp deepsource_report.html reports/deepsource_report.html; fi
  artifacts:
    expire_in: 1 week
    paths:
      - reports/snyk-backend.html
      - reports/trivy-backend.html
      - reports/trivy-frontend.html
      - reports/deepsource_report.html
    when: always

# -----------------------------------------------------
# DAST = OWASP ZAP
# -----------------------------------------------------
dast_zap:
  stage: dast
  image: docker:25
  services:
    - docker:25-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
    - mkdir -p $CI_PROJECT_DIR/.zap
    - docker compose -f docker-compose.yml --profile ci up -d || true
    - sleep 20
    - docker run --network ${COMPOSE_PROJECT_NAME}_default -v "$CI_PROJECT_DIR/.zap:/zap/wrk" owasp/zap2docker-stable zap-baseline.py -t "${ZAP_TARGET}" -r zap-baseline.html || true
    - mkdir -p reports
    - mv $CI_PROJECT_DIR/.zap/zap-baseline.html reports/zap-baseline.html || true
    - if [ -f deepsource_report.html ]; then cp deepsource_report.html reports/deepsource_report.html; fi
  artifacts:
    expire_in: 1 week
    when: always
    paths:
      - reports/zap-baseline.html
      - reports/deepsource_report.html
